{% extends 'base.html' %}

{% load static %}

{% block css %}
    {{ block.super }}
    <link rel="stylesheet" href="{% static 'css/post_detail.css' %}?v={{ timestamp }}">
{% endblock %}

{% block content_wrapper %}
    <main class="content-wrapper" style="margin-top: 25px;">

    {% block content %}
    <div class="content-container">
        <!-- å·¦ä¾§é¢„ç•™ç©ºé—´ -->
        <div class="side-placeholder side-placeholder-left"></div>

        <!-- å³ä¾§é¢„ç•™ç©ºé—´ -->
        <div class="side-placeholder side-placeholder-right"></div>

        <div class="post-content-wrapper">
            <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
            <div class="back-to-home">
                <button id="backToHomeBtn" class="back-button" title="è¿”å›é¦–é¡µ">
                    <span class="back-icon">ğŸ </span>
                    <span class="back-text">é¦–é¡µ</span>
                </button>
            </div>

            <!-- å¸–å­æ ‡é¢˜åŒºåŸŸ -->
            <header class="post-header">
                <h1 class="post-title">{{ post.title }}</h1>

                <!-- ä½œè€…å’Œåˆ†ç±»ä¿¡æ¯ -->
                <div class="post-meta">
                    <div class="post-author">
                        <img id="user-avatar" alt="ç”¨æˆ·å¤´åƒ" class="avatar"
                             src="{% if post.author.avatar %}{{ post.author.avatar.url }}
                                  {% else %}{% static 'images/ç”³é¹¤.jpg' %}
                                  {% endif %}">
                        <span>{{ post.author.username }}</span>
                    </div>

                    <!-- åˆ†ç±»æ ‡ç­¾ -->
                    <div class="post-categories">
                        {% for category in categories %}
                            <span class="category-tag">{{ category.name }}</span>
                        {% endfor %}
                    </div>
                </div>

                <!-- æµè§ˆé‡å’Œå‘å¸ƒæ—¶é—´ -->
                <div class="post-stats">
                    <div class="stat-item">
                        <span class="stat-icon">ğŸ‘ï¸</span>
                        <span>{{ post.views }} æµè§ˆ</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-icon">ğŸ“…</span>
                        <span>{{ post.created_at|date:"Y-m-d H:i" }}</span>
                    </div>
                </div>
            </header>

            <!-- å¸–å­å†…å®¹ -->
            <article class="post-content">
                {{ post.content|linebreaks }}
            </article>

            <!-- ç¼–è¾‘æŒ‰é’® -->
            {% if user.is_authenticated and user == post.author %}
                <div style="text-align: right; margin-top: 20px;">
                    <a href="{% url 'chat:edit_post_html' post.id %}" class="edit-post-link">ç¼–è¾‘å¸–å­</a>
                    <span>çŠ¶æ€ï¼š{{ post.get_status_display }}</span>
                </div>
            {% endif %}

            <!-- ç‚¹èµåŒºåŸŸ -->
            <div class="post-like-section">
                <div id="post_like_section"></div>
            </div>

            <!-- è¯„è®ºåŒº -->
            <section class="comments-section">
                <h2 class="comments-title">è¯„è®º</h2>

                <!-- è¯„è®ºè¡¨å• -->
                <form id="add_comment" class="comment-form">
                    <label for="content">è¯·è¾“å…¥è¯„è®ºï¼š</label>
                    <input type="text" name="content" placeholder="è¯·è¾“å…¥å†…å®¹" id="content">
                    {% csrf_token %}
                    <button type="submit">æäº¤è¯„è®º</button>
                </form>

                <!-- è¯„è®ºåˆ—è¡¨ -->
                <div id="post-comments-content" class="comments-list" data-post-id="{{ post.id }}"></div>

                <!-- åˆ†é¡µæ§ä»¶ -->
                <div id="post-comments-pagination" class="pagination"></div>
            </section>
        </div>
    </div>

    {% endblock %}
    </main>
{% endblock %}

{% block js %}
    {{ block.super }}
    <script>
        const post_id = {{ post.id }}
        const comment_api_url = "{% url 'chat:comment' post.id %}"
        const add_comment_api_url = "{% url 'chat:add_comment' post.id %}"
        const post_like_api_url = "{% url 'chat:like_post' post.id %}"
    </script>

    <script src="{% static 'js/comment.js' %}"></script>

    <script>
        // è¿”å›é¦–é¡µæŒ‰é’®åŠŸèƒ½
        document.getElementById('backToHomeBtn').addEventListener('click', function() {
            window.location.href = "/index";
        });

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        document.addEventListener("DOMContentLoaded", function(){
            //å¸–å­ç‚¹èµ
            const likeButton = document.getElementById('post_like_section');

            async function postLikeButton(is_init=false) {
                try {
                    const response = await fetch(post_like_api_url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrfToken
                        },
                        body: JSON.stringify({ 'is_init': is_init }),
                    });

                    const like_data = await response.json();

                    likeButton.innerHTML = `
                    <button class="like-button ${like_data.is_liked ? 'liked' : ''}" id="post_like_button">
                        <span class="like-icon">
                        ${like_data.is_liked ? 'â¤ï¸' : 'ğŸ¤'}
                        ${like_data.is_liked ? 'å·²ç‚¹èµ' : 'ç‚¹èµ'}</span>(${like_data.like_count})
                    </button>`;

                    document.getElementById('post_like_button').addEventListener('click',()=> postLikeButton(false));
                } catch(error) {
                    console.log('ç‚¹èµå¤±è´¥ï¼š',error);
                }
            }
            postLikeButton(true);
        });
    </script>

{% endblock %}
